<script>
let products=[],current=null,imgs=[],imgIndex=0

fetch("https://dombet-backend.onrender.com/products")
.then(r=>r.json())
.then(d=>{
  products=d
  loadFromURL()
})

/* ======================
   LISTADO
====================== */
function renderList(push=true){
  list.innerHTML=""
  list.style.display="grid"

  if(push){
    history.pushState({page:"home"}, "", "/")
  }

  products.forEach((p,i)=>{
    list.innerHTML+=`
      <div class="card" onclick="openDetail(${i})">
        <img src="${p.image_main}">
        <div class="name">${p.name}</div>
        <div class="price">Gs. ${Number(p.price).toLocaleString()}</div>
        <button class="btn">Ver producto</button>
      </div>`
  })
}

/* ======================
   DETALLE (simple)
====================== */
function openDetail(i,push=true){
  current=products[i]

  list.style.display="none"

  list.insertAdjacentHTML("afterend", `
    <div class="detail" id="detail">
      <div class="detail-box">
        <div class="gallery">
          <img src="${current.image_main}" style="width:100%;height:420px;object-fit:contain">
        </div>
        <div class="info">
          <h2>${current.name}</h2>
          <div class="price">Gs. ${Number(current.price).toLocaleString()}</div>
          <p>${current.description||""}</p>
          <button class="btn btn-whats" onclick="buyWhats()">Comprar por WhatsApp</button>
        </div>
      </div>
    </div>
  `)

  if(push){
    history.pushState(
      {page:"product",index:i},
      "",
      `?product=${i}`
    )
  }
}

/* ======================
   VOLVER
====================== */
function goHome(){
  const d=document.getElementById("detail")
  if(d) d.remove()
  renderList()
}

/* ======================
   HISTORIAL ← →
====================== */
window.onpopstate=e=>{
  const d=document.getElementById("detail")
  if(d) d.remove()

  if(!e.state || e.state.page==="home"){
    renderList(false)
  }else if(e.state.page==="product"){
    openDetail(e.state.index,false)
  }
}

/* ======================
   CARGA POR URL (F5)
====================== */
function loadFromURL(){
  const params=new URLSearchParams(location.search)
  const p=params.get("product")

  if(p!==null && products[p]){
    openDetail(Number(p),false)
  }else{
    renderList(false)
  }
}

/* ======================
   BUSCADOR
====================== */
searchInput.oninput=e=>{
  const t=e.target.value.toLowerCase()
  if(!t){
    searchResults.style.display="none"
    return
  }

  const f=products.filter(p=>p.name.toLowerCase().includes(t))
  searchResults.innerHTML=f.map(p=>{
    const i=products.indexOf(p)
    return `
      <div class="search-item" onclick="openDetail(${i});searchResults.style.display='none'">
        <img src="${p.image_main}">
        <div>${p.name}</div>
      </div>`
  }).join("")

  searchResults.style.display="block"
}

/* ======================
   WHATSAPP
====================== */
function buyWhats(){
  window.open(
    "https://wa.me/595985697384?text="+encodeURIComponent(
      `Hola! Quiero comprar:\n${current.name}`
    )
  )
}
</script>
