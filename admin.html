<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin DomBet</title>

<style>
body {
    font-family: Arial;
    background: #0a1a3a;
    margin: 0;
}

/* ===== ADMIN ===== */
.admin {
    padding: 30px;
}

h1 {
    color: white;
    text-align: center;
    margin-bottom: 20px;
}

/* TOPBAR */
.topbar {
    position: fixed;
    top: 15px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 100;
}

.btn {
    border: none;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
    color: white;
    font-weight: bold;
}

.btn-save { background: #25D366; }

/* ===== PANEL ===== */
.grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 25px;
}

.card {
    background: white;
    padding: 10px;
    border-radius: 10px;
    box-shadow: none;
}

.preview {
    width: 100%;
    height: 140px;
    background: #f0f2f5;
    border: none;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 6px;
}

.preview img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.placeholder {
    color: #0a1a3a;
    font-size: 14px;
}

.thumbs {
    display: flex;
    gap: 6px;
    margin-bottom: 4px;
    overflow-x: auto;
}

.thumb {
    width: 40px;
    height: 40px;
    border: 1px solid #0a1a3a;
    border-radius: 6px;
    overflow: hidden;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
}

.thumb img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.thumb button {
    position: absolute;
    top: 0;
    right: 0;
    background: rgba(198, 40, 40, 0.8);
    border: none;
    color: white;
    width: 100%;
    height: 100%;
    font-size: 16px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.thumb:hover button {
    opacity: 1;
}

input, textarea {
    width: 100%;
    margin-top: 5px;
    padding: 6px 10px;
    font-size: 13px;
    border-radius: 6px;
    border: none;
    background: #f0f2f5;
    box-sizing: border-box;
}

textarea {
    min-height: 40px;
    resize: vertical;
}

.available {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 5px;
    font-size: 13px;
}

.available input {
    width: auto;
    margin: 0;
}

.pagination {
    margin-top: 25px;
    display: flex;
    justify-content: center;
    gap: 20px;
    color: white;
}

.pagination button {
    background: #0a1a3a;
    border: 1px solid white;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
}

.actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.btn-sold {
    flex: 2;
    background: #25D366;
    color: white;
    border: none;
    padding: 8px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
    transition: transform 0.2s;
}
.btn-sold:hover { transform: scale(1.02); background: #20bd5a; }
.btn-sold:active { transform: scale(0.98); }

.btn-delete {
    flex: 1;
    background: #d32f2f;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
}
.btn-delete:hover { background: #b71c1c; }

/* STATUS BADGE (BOT√ìN NARANJA) */
.sold-badge {
    margin-top: 8px;
    background: #ff9800;
    color: white;
    padding: 8px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    font-size: 13px;
    display: none; /* Oculto por defecto */
}

/* TOTAL PANEL (CENTER) */
.total-panel {
    text-align: center;
    margin: 0 auto 40px auto;
    background: rgba(255,255,255,0.05);
    padding: 20px 40px;
    border-radius: 16px;
    width: fit-content;
    border: 1px solid rgba(255,255,255,0.1);
}
.total-panel h3 { margin: 0 0 5px 0; color: #ffeb3b; font-size: 20px; text-transform: uppercase; letter-spacing: 2px; }
.total-panel .amount { font-size: 54px; font-weight: 300; color: #ffffff; font-family: 'Segoe UI Light', 'Segoe UI', sans-serif; letter-spacing: 1px; }

</style>
</head>

<body>

<!-- ADMIN -->
<div class="admin" id="admin">
    <div class="topbar">
        <button class="btn btn-save" onclick="saveAll()">üíæ Guardar Cambios</button>
    </div>

    <h1>ADMIN DOMBET</h1>

    <div class="total-panel">
        <h3>VENTAS DEL MES</h3>
        <div class="amount" id="globalTotal">Gs. 0</div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="pagination">
        <button onclick="prevPage()">‚¨Ö Atr√°s</button>
        <span id="pageInfo"></span>
        <button onclick="nextPage()">Adelante ‚û°</button>
    </div>
</div>

<script>
/* ===== CONFIG ===== */
const API = "/products";
const ITEMS_PER_PAGE = 25;
const MAX_IMAGES = 3;

/* ===== STATE ===== */
let products = [];
let currentPage = 0;
let totalPages = 1;

function formatPrice(p) { return Number(p).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

/* ===== INIT ===== */
loadProducts();
loadTotal();

/* ===== DATA LOAD ===== */
function loadProducts() {
    fetch(API)
        .then(r => r.json())
        .then(data => {
            // Mapeamos los datos del servidor al formato local
            products = data.map(p => ({
                id: p.id,
                name: p.name || "",
                description: p.description || "",
                // Aseguramos que images sea un array
                images: Array.isArray(p.images) ? p.images : [],
                price: p.price || 0,
                discount: p.discount || 0,
                available: p.available !== 0 // MySQL devuelve 0 o 1
            }));

            // Agregar 150 espacios vac√≠os (6 p√°ginas de 25 items cada una)
            for(let i=0; i<150; i++) {
                products.push({
                    id: null, // Sin ID = Nuevo producto
                    name: "",
                    description: "",
                    images: [],
                    price: 0,
                    discount: 0,
                    available: true
                });
            }
            renderPage();
        })
        .catch(err => console.error("Error cargando productos:", err));
}

function loadTotal() {
    fetch("/sales/month?t=" + Date.now())
        .then(r => r.json())
        .then(data => {
            const rawTotal = Number(data.total) || 0;
            const total = formatPrice(rawTotal);
            const el = document.getElementById("globalTotal");
            el.innerText = "Gs. " + total;

            if (rawTotal > 2000000) {
                el.style.color = "#76ff03"; // Verde Lim√≥n
            } else if (rawTotal > 1000000) {
                el.style.color = "#ff9800"; // Naranja
            } else {
                el.style.color = "#d32f2f"; // Rojo
            }
        });
}

function updateProductBadge(i) {
    const p = products[i];
    fetch("/sales/product_stats?name=" + encodeURIComponent(p.name) + "&t=" + Date.now())
        .then(r => r.json())
        .then(data => {
            const msg = document.getElementById("soldMsg" + i);
            if(!msg) return;

            // Siempre visible
            msg.style.display = "block";
            msg.innerText = `Vendidos: ${data.count} | Gs. ${formatPrice(data.total)}`;

            // L√≥gica de colores
            msg.style.color = "white"; // Texto blanco por defecto
            if (data.count === 0) {
                msg.style.background = "#607d8b"; // Gris (0 ventas)
            } else if (data.count === 1) {
                msg.style.background = "#d32f2f"; // Rojo (1 venta)
            } else if (data.count === 2) {
                msg.style.background = "#fbc02d"; // Amarillo (2 ventas)
                msg.style.color = "black";        // Texto negro
            } else if (data.count === 3) {
                msg.style.background = "#ff9800"; // Naranja (3 ventas)
            } else if (data.count === 4) {
                msg.style.background = "#2e7d32"; // Verde Oscuro (4 ventas)
            } else {
                msg.style.background = "#76ff03"; // Verde Lim√≥n (5+ ventas)
                msg.style.color = "black";        // Texto negro
            }
        });
}

function markAsSold(i) {
    const p = products[i];
    const price = Number(p.price);
    if (!price) return alert("El producto no tiene precio");

    fetch("/sales", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            product_name: p.name,
            quantity: 1,
            total: price
        })
    })
    .then(() => {
        loadTotal();          // Actualizar total global
        updateProductBadge(i); // Actualizar contador individual
    });
}

function undoSale(i) {
    const p = products[i];
    
    // Buscar la √∫ltima venta de este producto en la BD para asegurar el borrado
    fetch("/sales/last?name=" + encodeURIComponent(p.name))
        .then(r => r.json())
        .then(data => {
            if (data.id) {
                fetch("/sales/" + data.id, { method: "DELETE" })
                .then(() => {
                    loadTotal();          // Actualizar total global
                    updateProductBadge(i); // Actualizar contador individual
                });
            } else {
                alert("No hay ventas recientes para borrar de este producto.");
            }
        });
}

/* ===== RENDER ===== */
const grid = document.getElementById("grid");
const pageInfo = document.getElementById("pageInfo");

function renderPage() {
    // Calcular paginaci√≥n din√°mica
    totalPages = Math.ceil(products.length / ITEMS_PER_PAGE) || 1;
    const start = currentPage * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageItems = products.slice(start, end);

    let html = "";
    pageItems.forEach((p, index) => {
        const i = start + index; // √çndice real en el array global

        html += `
        <div class="card">
            <input placeholder="Nombre" value="${p.name}"
                onchange="update(${i},'name',this.value)">

            <div class="preview" id="preview${i}">
                ${p.images[0] ? `<img src="${p.images[0]}">` : `<span class="placeholder">Sin imagen</span>`}
            </div>

            <div class="thumbs">
                ${p.images.map((img, idx) => `
                <div class="thumb" onclick="showImg(${i},${idx})">
                    <img src="${img}">
                    <button onclick="event.stopPropagation();removeImg(${i},${idx})">√ó</button>
                </div>`).join("")}
            </div>

            <input type="file" accept="image/*"
                onchange="addImg(event,${i})" ${p.images.length >= MAX_IMAGES ? "disabled" : ""}>

            <textarea placeholder="Descripci√≥n" onchange="update(${i},'description',this.value)">${p.description}</textarea>

            <div style="display:flex; gap:5px;">
                <input type="number" placeholder="Precio"
                    value="${p.price || ''}" onchange="update(${i},'price',this.value)">

                <input type="number" placeholder="Descuento %"
                    value="${p.discount || ''}" onchange="update(${i},'discount',this.value)">
            </div>

            <div class="available">
                <input type="checkbox" ${p.available ? "checked" : ""}
                    onchange="update(${i},'available',this.checked)">
                <label>Disponible</label>
            </div>

            <div class="actions">
                <button class="btn-sold" onclick="markAsSold(${i})">VENDIDO</button>
                <button class="btn-delete" onclick="undoSale(${i})">BORRAR</button>
            </div>
            <div id="soldMsg${i}" class="sold-badge"></div>
        </div>`;
    });
    
    grid.innerHTML = html;

    // Actualizar contadores de esta p√°gina
    pageItems.forEach((p, index) => {
        updateProductBadge(start + index);
    });

    pageInfo.innerText = `P√°gina ${currentPage + 1} de ${totalPages}`;
}

/* ===== LOGIC ===== */
function update(i, field, value) {
    products[i][field] = value;
}

function addImg(e, i) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
        products[i].images.push(ev.target.result);
        renderPage();
    };
    reader.readAsDataURL(file);
}

function removeImg(i, idx) {
    products[i].images.splice(idx, 1);
    renderPage();
}

function showImg(i, idx) {
    const preview = document.getElementById("preview" + i);
    preview.innerHTML = `<img src="${products[i].images[idx]}">`;
}

function nextPage() {
    if (currentPage < totalPages - 1) {
        currentPage++;
        renderPage();
    }
}

function prevPage() {
    if (currentPage > 0) {
        currentPage--;
        renderPage();
    }
}

/* ===== SAVE TO SERVER ===== */
async function saveAll() {
    const btn = document.querySelector(".btn-save");
    const originalText = btn.innerText;
    btn.innerText = "Guardando...";
    btn.disabled = true;

    try {
        for (const p of products) {
            // 1. ACTUALIZAR EXISTENTE (PUT)
            if (p.id) {
                const response = await fetch(`${API}/${p.id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name: p.name,
                        description: p.description,
                        price: Number(p.price) || 0,
                        discount: Number(p.discount) || 0,
                        available: p.available ? 1 : 0,
                        images: p.images
                    })
                });
                if (!response.ok) throw new Error("Error actualizando ID: " + p.id);
            }
            // 2. CREAR NUEVO (POST) - Solo si tiene nombre o imagen
            else if (p.name || p.images.length > 0) {
                const response = await fetch(API, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name: p.name,
                        description: p.description,
                        price: Number(p.price) || 0,
                        discount: Number(p.discount) || 0,
                        available: p.available ? 1 : 0,
                        images: p.images
                    })
                });
                if (!response.ok) throw new Error("Error creando nuevo producto");
            }
        }
        alert("‚úÖ Cambios guardados correctamente");
    } catch (error) {
        console.error(error);
        alert("‚ùå Error al guardar. Revisa la consola del servidor.");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
        loadProducts(); // Recargar para asegurar sincronizaci√≥n
    }
}
</script>

</body>
</html>
